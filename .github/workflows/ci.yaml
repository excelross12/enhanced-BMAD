name: CI Pipeline

# Enhanced CI pipeline with parallel execution, matrix testing, and intelligent caching
# Validates code quality, runs tests, builds documentation, and enforces coverage thresholds

on:
  pull_request:
    branches: ['**']
  push:
    branches: ['**']
  workflow_dispatch:

env:
  NODE_ENV: test
  CACHE_VERSION: v1

jobs:
  # Setup job: Installs dependencies and creates cache for downstream jobs
  setup:
    name: Setup and Cache Dependencies
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache.outputs.cache-hit }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Cache dependencies
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}-${{ env.CACHE_VERSION }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        if: steps.cache.outputs.cache-hit != 'true'
        run: npm ci

  # Parallel lint jobs
  lint-js:
    name: ESLint
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js with cache
        uses: ./.github/actions/setup-node-cache
        with:
          node-version-file: '.nvmrc'

      - name: Run ESLint
        run: npm run lint

  lint-md:
    name: Markdownlint
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js with cache
        uses: ./.github/actions/setup-node-cache
        with:
          node-version-file: '.nvmrc'

      - name: Run Markdownlint
        run: npm run lint:md

  format-check:
    name: Prettier Format Check
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js with cache
        uses: ./.github/actions/setup-node-cache
        with:
          node-version-file: '.nvmrc'

      - name: Check formatting
        run: npm run format:check

  # Matrix testing on Node.js 20 and 22
  test:
    name: Tests (Node ${{ matrix.node-version }})
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20, 22]
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Restore dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}-${{ env.CACHE_VERSION }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Upload coverage to Codecov
        if: matrix.node-version == 22
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-node-${{ matrix.node-version }}
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      # Upload coverage artifacts: HTML reports and lcov for analysis
      - name: Upload coverage artifacts
        if: matrix.node-version == 22
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-node-${{ matrix.node-version }}
          path: |
            coverage/
            !coverage/**/*.tmp
          retention-days: 7
          if-no-files-found: warn

      - name: Generate coverage summary
        if: matrix.node-version == 22 && github.event_name == 'pull_request'
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            node -e "
              const coverage = require('./coverage/coverage-summary.json');
              const total = coverage.total;
              console.log('| Metric | Coverage | Status |');
              console.log('|--------|----------|--------|');
              const metrics = ['lines', 'statements', 'functions', 'branches'];
              metrics.forEach(metric => {
                const pct = total[metric].pct;
                const status = pct >= 70 ? '‚úÖ' : '‚ùå';
                console.log(\`| \${metric.charAt(0).toUpperCase() + metric.slice(1)} | \${pct.toFixed(2)}% | \${status} |\`);
              });
            " >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Threshold:** 70% minimum for all metrics" >> $GITHUB_STEP_SUMMARY
          fi

  # Validation jobs
  validate-schemas:
    name: Schema Validation
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js with cache
        uses: ./.github/actions/setup-node-cache
        with:
          node-version-file: '.nvmrc'

      - name: Validate YAML schemas
        run: npm run validate:schemas

      - name: Run schema tests
        run: npm run test:schemas

  validate-refs:
    name: File Reference Validation
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js with cache
        uses: ./.github/actions/setup-node-cache
        with:
          node-version-file: '.nvmrc'

      - name: Validate file references
        run: npm run validate:refs

      - name: Test file references
        run: npm run test:refs

  validate-installation:
    name: Installation Component Tests
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js with cache
        uses: ./.github/actions/setup-node-cache
        with:
          node-version-file: '.nvmrc'

      - name: Test installation components
        run: npm run test:install

  # Documentation build job
  build-docs:
    name: Build Documentation
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js with cache
        uses: ./.github/actions/setup-node-cache
        with:
          node-version-file: '.nvmrc'

      - name: Build documentation
        run: npm run docs:build

      # Upload documentation build artifacts for deployment and review
      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: docs-build
          path: website/dist/
          retention-days: 7
          if-no-files-found: error

  # Status aggregation job - provides clear pass/fail status with actionable error messages
  ci-status:
    name: CI Status Check
    if: always()
    needs:
      - lint-js
      - lint-md
      - format-check
      - test
      - validate-schemas
      - validate-refs
      - validate-installation
      - build-docs
    runs-on: ubuntu-latest
    steps:
      - name: Aggregate and report CI status
        run: |
          echo "================================================"
          echo "CI Pipeline Status Report"
          echo "================================================"
          echo ""
          
          # Define job results
          LINT_JS="${{ needs.lint-js.result }}"
          LINT_MD="${{ needs.lint-md.result }}"
          FORMAT="${{ needs.format-check.result }}"
          TEST="${{ needs.test.result }}"
          SCHEMAS="${{ needs.validate-schemas.result }}"
          REFS="${{ needs.validate-refs.result }}"
          INSTALL="${{ needs.validate-installation.result }}"
          DOCS="${{ needs.build-docs.result }}"
          
          # Track failures
          FAILED_JOBS=()
          ALL_PASSED=true
          
          # Check each job and collect failures
          echo "Job Results:"
          echo "------------"
          
          if [[ "$LINT_JS" == "success" ]]; then
            echo "‚úÖ ESLint: PASSED"
          else
            echo "‚ùå ESLint: FAILED"
            FAILED_JOBS+=("lint-js")
            ALL_PASSED=false
          fi
          
          if [[ "$LINT_MD" == "success" ]]; then
            echo "‚úÖ Markdownlint: PASSED"
          else
            echo "‚ùå Markdownlint: FAILED"
            FAILED_JOBS+=("lint-md")
            ALL_PASSED=false
          fi
          
          if [[ "$FORMAT" == "success" ]]; then
            echo "‚úÖ Prettier Format Check: PASSED"
          else
            echo "‚ùå Prettier Format Check: FAILED"
            FAILED_JOBS+=("format-check")
            ALL_PASSED=false
          fi
          
          if [[ "$TEST" == "success" ]]; then
            echo "‚úÖ Tests (Node 20 & 22): PASSED"
          else
            echo "‚ùå Tests (Node 20 & 22): FAILED"
            FAILED_JOBS+=("test")
            ALL_PASSED=false
          fi
          
          if [[ "$SCHEMAS" == "success" ]]; then
            echo "‚úÖ Schema Validation: PASSED"
          else
            echo "‚ùå Schema Validation: FAILED"
            FAILED_JOBS+=("validate-schemas")
            ALL_PASSED=false
          fi
          
          if [[ "$REFS" == "success" ]]; then
            echo "‚úÖ File Reference Validation: PASSED"
          else
            echo "‚ùå File Reference Validation: FAILED"
            FAILED_JOBS+=("validate-refs")
            ALL_PASSED=false
          fi
          
          if [[ "$INSTALL" == "success" ]]; then
            echo "‚úÖ Installation Tests: PASSED"
          else
            echo "‚ùå Installation Tests: FAILED"
            FAILED_JOBS+=("validate-installation")
            ALL_PASSED=false
          fi
          
          if [[ "$DOCS" == "success" ]]; then
            echo "‚úÖ Documentation Build: PASSED"
          else
            echo "‚ùå Documentation Build: FAILED"
            FAILED_JOBS+=("build-docs")
            ALL_PASSED=false
          fi
          
          echo ""
          echo "================================================"
          
          # If all passed, report success
          if [[ "$ALL_PASSED" == "true" ]]; then
            echo ""
            echo "üéâ SUCCESS: All CI checks passed!"
            echo ""
            echo "All quality gates have been satisfied:"
            echo "  ‚Ä¢ Code quality (ESLint, Prettier)"
            echo "  ‚Ä¢ Documentation quality (Markdownlint)"
            echo "  ‚Ä¢ Test coverage (Node.js 20 & 22)"
            echo "  ‚Ä¢ Schema integrity"
            echo "  ‚Ä¢ File reference integrity"
            echo "  ‚Ä¢ Installation components"
            echo "  ‚Ä¢ Documentation build"
            echo ""
            echo "Your changes are ready for review and merge."
            exit 0
          fi
          
          # If any failed, provide detailed guidance
          echo ""
          echo "‚ùå FAILURE: ${#FAILED_JOBS[@]} job(s) failed"
          echo ""
          echo "Failed Jobs: ${FAILED_JOBS[*]}"
          echo ""
          echo "================================================"
          echo "Troubleshooting Guide"
          echo "================================================"
          echo ""
          
          # Provide specific guidance for each failed job
          for job in "${FAILED_JOBS[@]}"; do
            case "$job" in
              "lint-js")
                echo "üìã ESLint Failures"
                echo "-------------------"
                echo "ESLint found code quality issues in your JavaScript/TypeScript files."
                echo ""
                echo "To fix locally:"
                echo "  1. Run: npm run lint"
                echo "  2. Review the errors and warnings"
                echo "  3. Auto-fix where possible: npm run lint:fix"
                echo "  4. Manually fix remaining issues"
                echo ""
                echo "Common issues:"
                echo "  ‚Ä¢ Unused variables or imports"
                echo "  ‚Ä¢ Missing semicolons or incorrect spacing"
                echo "  ‚Ä¢ Deprecated API usage"
                echo "  ‚Ä¢ Console.log statements in production code"
                echo ""
                echo "Check the 'ESLint' job logs above for specific file locations and error messages."
                echo ""
                ;;
              "lint-md")
                echo "üìã Markdownlint Failures"
                echo "------------------------"
                echo "Markdownlint found formatting issues in your Markdown files."
                echo ""
                echo "To fix locally:"
                echo "  1. Run: npm run lint:md"
                echo "  2. Review the errors"
                echo "  3. Auto-fix where possible: npm run lint:md:fix"
                echo "  4. Manually fix remaining issues"
                echo ""
                echo "Common issues:"
                echo "  ‚Ä¢ Inconsistent heading levels"
                echo "  ‚Ä¢ Missing blank lines around lists or code blocks"
                echo "  ‚Ä¢ Trailing whitespace"
                echo "  ‚Ä¢ Line length violations"
                echo ""
                echo "Check the 'Markdownlint' job logs above for specific file locations and line numbers."
                echo ""
                ;;
              "format-check")
                echo "üìã Prettier Format Check Failures"
                echo "----------------------------------"
                echo "Prettier detected formatting inconsistencies in your code."
                echo ""
                echo "To fix locally:"
                echo "  1. Run: npm run format:check (to see what needs formatting)"
                echo "  2. Run: npm run format:fix (to auto-format all files)"
                echo "  3. Commit the formatted changes"
                echo ""
                echo "Common issues:"
                echo "  ‚Ä¢ Inconsistent indentation (tabs vs spaces)"
                echo "  ‚Ä¢ Inconsistent quote styles"
                echo "  ‚Ä¢ Missing or extra trailing commas"
                echo "  ‚Ä¢ Line length violations"
                echo ""
                echo "Note: Prettier auto-fixes all issues, so just run 'npm run format:fix'."
                echo ""
                ;;
              "test")
                echo "üìã Test Failures"
                echo "----------------"
                echo "One or more tests failed on Node.js 20 or 22."
                echo ""
                echo "To fix locally:"
                echo "  1. Run: npm test (to run all tests)"
                echo "  2. Run: npm run test:coverage (to see coverage report)"
                echo "  3. Review failing test output for specific assertions"
                echo "  4. Fix the code or update tests as needed"
                echo ""
                echo "Common issues:"
                echo "  ‚Ä¢ Test assertions failing due to code changes"
                echo "  ‚Ä¢ Coverage below 70% threshold"
                echo "  ‚Ä¢ Async test timeouts"
                echo "  ‚Ä¢ Missing test data or fixtures"
                echo ""
                echo "Check the 'Tests' job logs above for:"
                echo "  ‚Ä¢ Test names that failed"
                echo "  ‚Ä¢ Expected vs actual values"
                echo "  ‚Ä¢ Stack traces showing failure location"
                echo "  ‚Ä¢ Coverage percentages by file"
                echo ""
                ;;
              "validate-schemas")
                echo "üìã Schema Validation Failures"
                echo "------------------------------"
                echo "YAML schema validation detected issues in workflow or configuration files."
                echo ""
                echo "To fix locally:"
                echo "  1. Run: npm run validate:schemas"
                echo "  2. Run: npm run test:schemas"
                echo "  3. Review the validation errors"
                echo "  4. Fix YAML syntax or schema violations"
                echo ""
                echo "Common issues:"
                echo "  ‚Ä¢ Invalid YAML syntax (indentation, colons, quotes)"
                echo "  ‚Ä¢ Missing required fields in workflow definitions"
                echo "  ‚Ä¢ Invalid field values or types"
                echo "  ‚Ä¢ Schema version mismatches"
                echo ""
                echo "Check the 'Schema Validation' job logs above for specific files and validation errors."
                echo ""
                ;;
              "validate-refs")
                echo "üìã File Reference Validation Failures"
                echo "--------------------------------------"
                echo "File reference validation detected broken links or missing files."
                echo ""
                echo "To fix locally:"
                echo "  1. Run: npm run validate:refs"
                echo "  2. Run: npm run test:refs"
                echo "  3. Review the broken references"
                echo "  4. Fix file paths or restore missing files"
                echo ""
                echo "Common issues:"
                echo "  ‚Ä¢ Broken internal links in documentation"
                echo "  ‚Ä¢ References to deleted or moved files"
                echo "  ‚Ä¢ Incorrect relative paths"
                echo "  ‚Ä¢ Case sensitivity issues in file names"
                echo ""
                echo "Check the 'File Reference Validation' job logs above for specific broken references."
                echo ""
                ;;
              "validate-installation")
                echo "üìã Installation Test Failures"
                echo "------------------------------"
                echo "Installation component tests failed."
                echo ""
                echo "To fix locally:"
                echo "  1. Run: npm run test:install"
                echo "  2. Review the test failures"
                echo "  3. Fix installation scripts or components"
                echo ""
                echo "Common issues:"
                echo "  ‚Ä¢ Missing installation files or scripts"
                echo "  ‚Ä¢ Incorrect file permissions"
                echo "  ‚Ä¢ Path resolution issues"
                echo "  ‚Ä¢ Dependency installation problems"
                echo ""
                echo "Check the 'Installation Tests' job logs above for specific test failures."
                echo ""
                ;;
              "build-docs")
                echo "üìã Documentation Build Failures"
                echo "--------------------------------"
                echo "The documentation build process failed."
                echo ""
                echo "To fix locally:"
                echo "  1. Run: npm run docs:build"
                echo "  2. Review the build errors"
                echo "  3. Fix documentation syntax or configuration"
                echo ""
                echo "Common issues:"
                echo "  ‚Ä¢ Invalid Markdown syntax in docs"
                echo "  ‚Ä¢ Missing frontmatter in documentation pages"
                echo "  ‚Ä¢ Broken image or asset references"
                echo "  ‚Ä¢ Astro/Starlight configuration errors"
                echo "  ‚Ä¢ Missing dependencies for documentation build"
                echo ""
                echo "Check the 'Build Documentation' job logs above for specific build errors and file locations."
                echo ""
                ;;
            esac
          done
          
          echo "================================================"
          echo "Next Steps"
          echo "================================================"
          echo ""
          echo "1. Review the specific job logs above for detailed error messages"
          echo "2. Run the suggested commands locally to reproduce the failures"
          echo "3. Fix the issues in your local branch"
          echo "4. Test locally to ensure all checks pass"
          echo "5. Commit and push your fixes"
          echo "6. The CI pipeline will automatically re-run"
          echo ""
          echo "Need help? Check the documentation or ask the team."
          echo ""
          
          exit 1
